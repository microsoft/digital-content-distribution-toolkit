variables:
  RunNumber: '0.0.1-$(Build.BuildNumber)'

parameters:
  - name: onlyDeploy
    default: false
    type: boolean

  - name: deployBuildNumber
    default: latest
    type: string

trigger:
- manual

pool:
  vmImage: ubuntu-latest

stages:
- stage: Build
  condition: eq('${{ parameters.onlyDeploy }}', false)
  jobs:
  - job: Build
    steps:
    - task: Docker@2
      displayName: Login to ACR
      inputs:
        command: login
        containerRegistry: $(acr-service-connection)

    - task: CmdLine@2
      displayName: "Building docker image"
      inputs:
        script: "docker build -t $(image_name):$(RunNumber) -f ./blendnet.cms.web.ui/Dockerfile ."

    - task: CmdLine@2
      displayName: "Tagging docker image"
      inputs:
        script: "docker tag $(image_name):$(RunNumber) $(image_name):latest"

    - task: CmdLine@2
      displayName: "Pushing image to ACR"
      inputs:
        script: "docker push --all-tags $(image_name)"

    - task: Docker@2
      displayName: Logout of ACR
      inputs:
        command: logout
        containerRegistry: $(acr-service-connection)

- stage: Deploy
  dependsOn: Build
  condition: or(succeeded(), eq('${{ parameters.onlyDeploy }}', true))
  jobs:
  - job: Deploy
    steps:
    - task: CmdLine@2
      condition: eq('${{ parameters.onlyDeploy }}', false)
      inputs:
        script: 'sed -i ''s/blendnet.cms.web.ui:latest/blendnet.cms.web.ui:$(RunNumber)/g'' blendnet.cms.web.ui/blendnet.cms.web.ui.yaml'
    - task: CmdLine@2
      condition: eq('${{ parameters.onlyDeploy }}', true)
      inputs:
        script: 'sed -i ''s/blendnet.cms.web.ui:latest/blendnet.cms.web.ui:${{ parameters.deployBuildNumber }}/g'' blendnet.cms.web.ui/blendnet.cms.web.ui.yaml'
    - task: KubernetesManifest@0
      inputs:
        action: 'deploy'
        kubernetesServiceConnection: 'aks-blendnet-dev-default'
        manifests: 'blendnet.cms.web.ui/blendnet.cms.web.ui.yaml'

- stage: AppGateway
  dependsOn: Deploy
  condition: succeeded()
  jobs:
  - job: AppGateway
    steps:
    - task: KubernetesManifest@0
      inputs:
        action: 'deploy'
        kubernetesServiceConnection: 'aks-blendnet-dev-default'
        manifests: 'appgateway.yaml'
